{
   "Description":"IAM Policies and Roles for CI/CD Pipeline",
   "Parameters":{
      "CircleCIUser":{
         "Type":"String"
      },
      "ApplicationName":{
         "Type":"String"
      },
      "CodeDeployS3Bucket":{
         "Type":"String"
      },
      "ImageUploadS3Bucket":{
         "Type":"String"
      },
      "EmailDomainName":{
         "Type":"String"
      }
   },
   "Resources":{
      "CodeDeployEC2S3":{
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Action":[
                        "s3:Get*",
                        "s3:List*"
                     ],
                     "Effect":"Allow",
                     "Resource":[
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:s3:::",
                                 {
                                    "Ref":"CodeDeployS3Bucket"
                                 },
                                 "/*"
                              ]
                           ]
                        }
                     ]
                  }
               ]
            },
            "PolicyName":"CodeDeploy-EC2-S3",
            "Roles":[
               {
                  "Ref":"CodeDeployEC2ServiceRole"
               }
            ]
         }
      },
      "ImageUploadEC2S3":{
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Action":[
                        "s3:Put*",
                        "s3:Delete*",
                        "s3:Get*",
                        "s3:List*"
                     ],
                     "Effect":"Allow",
                     "Resource":[
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:s3:::",
                                 {
                                    "Ref":"ImageUploadS3Bucket"
                                 },
                                 "/*"
                              ]
                           ]
                        }
                     ]
                  }
               ]
            },
            "PolicyName":"Image-Upload-EC2-S3",
            "Roles":[
               {
                  "Ref":"CodeDeployEC2ServiceRole"
               }
            ]
         }
      },
      "CircleCICodeDeploy":{
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyName":"CircleCI-Code-Deploy",
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "codedeploy:RegisterApplicationRevision",
                        "codedeploy:GetApplicationRevision"
                     ],
                     "Resource":[
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:codedeploy:",
                                 {
                                    "Ref":"AWS::Region"
                                 },
                                 ":",
                                 {
                                    "Ref":"AWS::AccountId"
                                 },
                                 ":application:",
                                 {
                                    "Ref":"ApplicationName"
                                 }
                              ]
                           ]
                        }
                     ]
                  },
                  {
                     "Effect":"Allow",
                     "Action":[
                        "codedeploy:CreateDeployment",
                        "codedeploy:GetDeployment"
                     ],
                     "Resource":[
                        "*"
                     ]
                  },
                  {
                     "Effect":"Allow",
                     "Action":[
                        "codedeploy:GetDeploymentConfig"
                     ],
                     "Resource":[
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:codedeploy:",
                                 {
                                    "Ref":"AWS::Region"
                                 },
                                 ":",
                                 {
                                    "Ref":"AWS::AccountId"
                                 },
                                 ":deploymentconfig:CodeDeployDefault.OneAtATime"
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:codedeploy:",
                                 {
                                    "Ref":"AWS::Region"
                                 },
                                 ":",
                                 {
                                    "Ref":"AWS::AccountId"
                                 },
                                 ":deploymentconfig:CodeDeployDefault.HalfAtATime"
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:codedeploy:",
                                 {
                                    "Ref":"AWS::Region"
                                 },
                                 ":",
                                 {
                                    "Ref":"AWS::AccountId"
                                 },
                                 ":deploymentconfig:CodeDeployDefault.AllAtOnce"
                              ]
                           ]
                        }
                     ]
                  }
               ]
            },
            "Users":[
               {
                  "Ref":"CircleCIUser"
               }
            ]
         }
      },
      "CirlceCIUploadToS3":{
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyName":"CirlceCI-Upload-To-S3",
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "s3:PutObject"
                     ],
                     "Resource":[
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:s3:::",
                                 {
                                    "Ref":"CodeDeployS3Bucket"
                                 },
                                 "/*"
                              ]
                           ]
                        }
                     ]
                  }
               ]
            },
            "Users":[
               {
                  "Ref":"CircleCIUser"
               }
            ]
         }
      },
      "CircleCIEC2AMI":{
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyName":"CircleCI-EC2-AMI",
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "ec2:AttachVolume",
                        "ec2:AuthorizeSecurityGroupIngress",
                        "ec2:CopyImage",
                        "ec2:CreateImage",
                        "ec2:CreateKeypair",
                        "ec2:CreateSecurityGroup",
                        "ec2:CreateSnapshot",
                        "ec2:CreateTags",
                        "ec2:CreateVolume",
                        "ec2:DeleteKeyPair",
                        "ec2:DeleteSecurityGroup",
                        "ec2:DeleteSnapshot",
                        "ec2:DeleteVolume",
                        "ec2:DeregisterImage",
                        "ec2:DescribeImageAttribute",
                        "ec2:DescribeImages",
                        "ec2:DescribeInstances",
                        "ec2:DescribeInstanceStatus",
                        "ec2:DescribeRegions",
                        "ec2:DescribeSecurityGroups",
                        "ec2:DescribeSnapshots",
                        "ec2:DescribeSubnets",
                        "ec2:DescribeTags",
                        "ec2:DescribeVolumes",
                        "ec2:DetachVolume",
                        "ec2:GetPasswordData",
                        "ec2:ModifyImageAttribute",
                        "ec2:ModifyInstanceAttribute",
                        "ec2:ModifySnapshotAttribute",
                        "ec2:RegisterImage",
                        "ec2:RunInstances",
                        "ec2:StopInstances",
                        "ec2:TerminateInstances"
                     ],
                     "Resource":"*"
                  }
               ]
            },
            "Users":[
               {
                  "Ref":"CircleCIUser"
               }
            ]
         }
      },
      "CircleCIUpdateLambda":{
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "lambda:UpdateFunctionCode"
                     ],
                     "Resource":[
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:lambda:",
                                 {
                                    "Ref":"AWS::Region"
                                 },
                                 ":",
                                 {
                                    "Ref":"AWS::AccountId"
                                 },
                                 ":function:PasswordResetLambda"
                              ]
                           ]
                        }
                     ]
                  }
               ]
            },
            "PolicyName":"Circle-CI-Update-Lambda-Function",
            "Users":[
               {
                  "Ref":"CircleCIUser"
               }
            ]
         }
      },
      "CodeDeployServiceRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Sid":"",
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "codedeploy.amazonaws.com"
                        ]
                     },
                     "Action":"sts:AssumeRole"
                  }
               ]
            },
            "ManagedPolicyArns":[
               "arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole"
            ],
            "Path":"/",
            "RoleName":"CodeDeployServiceRole"
         }
      },
      "CodeDeployEC2ServiceRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "ec2.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "ManagedPolicyArns":[
               "arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy"
            ],
            "Policies":[
               {
                  "PolicyName":"SNSCreatePublishPolicy",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Effect":"Allow",
                           "Action":[
                              "sns:Publish",
                              "sns:CreateTopic",
                              "sns:ConfirmSubscription"
                           ],
                           "Resource":[
                              {
                                 "Fn::Join":[
                                    "",
                                    [
                                       "arn:aws:sns:",
                                       {
                                          "Ref":"AWS::Region"
                                       },
                                       ":",
                                       {
                                          "Ref":"AWS::AccountId"
                                       },
                                       ":password-reset"
                                    ]
                                 ]
                              }
                           ]
                        }
                     ]
                  }
               }
            ],
            "Path":"/",
            "RoleName":"CodeDeployEC2ServiceRole"
         }
      },
      "CodeDeployEC2InstanceProfile":{
         "Type":"AWS::IAM::InstanceProfile",
         "Properties":{
            "Path":"/",
            "Roles":[
               {
                  "Ref":"CodeDeployEC2ServiceRole"
               }
            ],
            "InstanceProfileName":"CodeDeployEC2InstanceProfile"
         }
      },
      "LambdaFunctionPolicy":{
         "DependsOn":[
            "LambdaFunctionRole"
         ],
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "dynamodb:BatchGetItem",
                        "dynamodb:GetItem",
                        "dynamodb:Query",
                        "dynamodb:BatchWriteItem",
                        "dynamodb:PutItem",
                        "dynamodb:UpdateItem"
                     ],
                     "Resource":[
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:dynamodb:",
                                 {
                                    "Ref":"AWS::Region"
                                 },
                                 ":",
                                 {
                                    "Ref":"AWS::AccountId"
                                 },
                                 ":table/csye6225"
                              ]
                           ]
                        }
                     ]
                  },
                  {
                     "Effect":"Allow",
                     "Action":[
                        "SES:SendEmail",
                        "SES:SendRawEmail"
                     ],
                     "Resource":[
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:ses:",
                                 {
                                    "Ref":"AWS::Region"
                                 },
                                 ":",
                                 {
                                    "Ref":"AWS::AccountId"
                                 },
                                 ":identity/",
                                 {
                                    "Ref":"EmailDomainName"
                                 }
                              ]
                           ]
                        }
                     ]
                  }
               ]
            },
            "PolicyName":"LambdaFunctionPolicy",
            "Roles":[
               {
                  "Ref":"LambdaFunctionRole"
               }
            ]
         }
      },
      "LambdaFunctionRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Sid":"",
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "lambda.amazonaws.com"
                        ]
                     },
                     "Action":"sts:AssumeRole"
                  }
               ]
            },
            "ManagedPolicyArns":[
               "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
            ],
            "Path":"/",
            "RoleName":"LambdaFunctionRole"
         }
      }
   },
   "Outputs":{
      "CodeDeployServiceRoleArn":{
         "Description":"Code Deploy Service Role Arn",
         "Value":{
            "Fn::GetAtt":[
               "CodeDeployServiceRole",
               "Arn"
            ]
         },
         "Export":{
            "Name":"CodeDeployServiceRoleOutput"
         }
      },
      "CodeDeployEC2ServiceRoleArn":{
         "Description":"Code Deploy EC2 Instance Profile",
         "Value":{
            "Ref":"CodeDeployEC2InstanceProfile"
         },
         "Export":{
            "Name":"CodeDeployEC2InstanceProfile"
         }
      },
      "LambdaFunctionRoleArn":{
         "Description":"Lambda Function Role",
         "Value":{
            "Fn::GetAtt":[
               "LambdaFunctionRole",
               "Arn"
            ]
         },
         "Export":{
            "Name":"LambdaFunctionRoleOutput"
         }
      }
   }
}